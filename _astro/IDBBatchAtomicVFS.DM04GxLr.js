import{B as $}from"./VFS.CeCEg8FG.js";import{aB as b,b as o,v as T,Y as N,aD as m,aF as I,aC as S,aE as v,S as O,aj as P,a as V,c as K,e as u,d as H,aU as U,aP as M,aQ as B,aR as Q,f as z}from"./sqlite-constants.C-WEsgk2.js";const W=b|S|m|v|I;class X{get state(){return this.#e}#e=b;timeoutMillis=0;#r=new Map;#t=Promise.resolve(0);async lock(e){return this.#s(this.#a,e)}async unlock(e){return this.#s(this.#n,e)}async isSomewhereReserved(){throw new Error("unimplemented")}async#s(e,s){const r=s&W;try{const t=()=>e.call(this,r);return await(this.#t=this.#t.then(t,t)),this.#e=r,o}catch(t){return t.name==="AbortError"?T:(console.error(t),N)}}async#a(e){if(e===this.#e)return o;switch(this.#e){case b:switch(e){case S:return this._NONEtoSHARED();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case S:switch(e){case m:return this._SHAREDtoRESERVED();case I:return this._SHAREDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case m:switch(e){case I:return this._RESERVEDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}}async#n(e){if(e===this.#e)return o;switch(this.#e){case I:switch(e){case S:return this._EXCLUSIVEtoSHARED();case b:return this._EXCLUSIVEtoNONE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case m:switch(e){case S:return this._RESERVEDtoSHARED();case b:return this._RESERVEDtoNONE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case S:switch(e){case b:return this._SHAREDtoNONE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}}async _NONEtoSHARED(){}async _SHAREDtoEXCLUSIVE(){await this._SHAREDtoRESERVED(),await this._RESERVEDtoEXCLUSIVE()}async _SHAREDtoRESERVED(){}async _RESERVEDtoEXCLUSIVE(){}async _EXCLUSIVEtoRESERVED(){}async _EXCLUSIVEtoSHARED(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED()}async _EXCLUSIVEtoNONE(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _RESERVEDtoSHARED(){}async _RESERVEDtoNONE(){await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _SHAREDtoNONE(){}_acquireWebLock(e,s){return new Promise(async(r,t)=>{try{await navigator.locks.request(e,s,n=>{if(r(n),n)return new Promise(a=>this.#r.set(e,a))})}catch(n){t(n)}})}_releaseWebLock(e){this.#r.get(e)?.(),this.#r.delete(e)}async _pollWebLock(e){return(await navigator.locks.query()).held.find(({name:r})=>r===e)?.mode}_getTimeoutSignal(){if(this.timeoutMillis){const e=new AbortController;return setTimeout(()=>e.abort(),this.timeoutMillis),e.signal}}}class j extends X{constructor(e){super(),this._lockName=e+"-outer",this._reservedName=e+"-reserved"}async isSomewhereReserved(){return await this._pollWebLock(this._reservedName)==="exclusive"}async _NONEtoSHARED(){await this._acquireWebLock(this._lockName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _SHAREDtoRESERVED(){await this._acquireWebLock(this._reservedName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _RESERVEDtoSHARED(){this._releaseWebLock(this._reservedName)}async _SHAREDtoNONE(){this._releaseWebLock(this._lockName)}}const F=5e3;let q=0;const x=new WeakMap;function w(...l){}class Y{#e;#r;#t;#s=null;#a=0;#n=Promise.resolve();#i=Promise.resolve();constructor(e,s={durability:"default"}){this.#r=Promise.resolve(e).then(r=>this.#e=r),this.#t=s}async close(){const e=this.#e??await this.#r;await this.#n,await this.sync(),e.close()}async run(e,s){const r=this.#n.then(()=>this.#c(e,s));return this.#n=r.catch(()=>{}),r}async#c(e,s){const r=this.#e??await this.#r;if(e==="readwrite"&&this.#s?.mode==="readonly")this.#s=null;else if(performance.now()-this.#a>F){try{this.#s?.commit()}catch(t){if(t.name!=="InvalidStateError")throw t}await new Promise(t=>setTimeout(t)),this.#s=null}for(let t=0;t<2;++t){if(!this.#s){this.#s=r.transaction(r.objectStoreNames,e,this.#t);const n=this.#a=performance.now();this.#i=this.#i.then(()=>new Promise((a,i)=>{this.#s.addEventListener("complete",c=>{a(),this.#s===c.target&&(this.#s=null),w(`transaction ${x.get(c.target)} complete`)}),this.#s.addEventListener("abort",c=>{console.warn("tx abort",(performance.now()-n)/1e3);const h=c.target.error;i(h),this.#s===c.target&&(this.#s=null),w(`transaction ${x.get(c.target)} aborted`,h)})})),x.set(this.#s,q++)}try{const n=Object.fromEntries(Array.from(r.objectStoreNames,a=>[a,new G(this.#s.objectStore(a))]));return await s(n)}catch(n){if(this.#s=null,t)throw n}}}async sync(){await this.#n,await this.#i,this.#i=Promise.resolve()}}function p(l){return new Promise((e,s)=>{l.addEventListener("success",()=>e(l.result)),l.addEventListener("error",()=>s(l.error))})}class G{#e;constructor(e){this.#e=e}get(e){w(`get ${this.#e.name}`,e);const s=this.#e.get(e);return p(s)}getAll(e,s){w(`getAll ${this.#e.name}`,e,s);const r=this.#e.getAll(e,s);return p(r)}getKey(e){w(`getKey ${this.#e.name}`,e);const s=this.#e.getKey(e);return p(s)}getAllKeys(e,s){w(`getAllKeys ${this.#e.name}`,e,s);const r=this.#e.getAllKeys(e,s);return p(r)}put(e,s){w(`put ${this.#e.name}`,e,s);const r=this.#e.put(e,s);return p(r)}delete(e){w(`delete ${this.#e.name}`,e);const s=this.#e.delete(e);return p(s)}clear(){w(`clear ${this.#e.name}`);const e=this.#e.clear();return p(e)}index(e){return new Z(this.#e.index(e))}}class Z{#e;constructor(e){this.#e=e}getAllKeys(e,s){w(`IDBIndex.getAllKeys ${this.#e.objectStore.name}<${this.#e.name}>`,e,s);const r=this.#e.getAllKeys(e,s);return p(r)}}const J=512,D=3e3,C={durability:"default",purge:"deferred",purgeAtLeast:16};function d(...l){}class re extends ${#e;#r=new Map;#t;#s=new Set;#a=performance.now();#n=new Set;constructor(e="wa-sqlite",s=C){super(),this.name=e,this.#e=Object.assign({},C,s),this.#t=new Y(ee(e),{durability:this.#e.durability})}async close(){for(const e of this.#r.keys())await this.xClose(e);await this.#t?.close(),this.#t=null}xOpen(e,s,r,t){return this.handleAsync(async()=>{e===null&&(e=`null_${s}`),d(`xOpen ${e} 0x${s.toString(16)} 0x${r.toString(16)}`);try{const n=new URL(e,"http://localhost/"),a={path:n.pathname,flags:r,block0:null,isMetadataChanged:!0,locks:new j(n.pathname)};return this.#r.set(s,a),await this.#t.run("readwrite",async({blocks:i})=>{if(a.block0=await i.get(this.#o(a,0)),!a.block0)if(r&O)a.block0={path:a.path,offset:0,version:0,data:new Uint8Array(0),fileSize:0},i.put(a.block0);else throw new Error(`file not found: ${a.path}`)}),t.setInt32(0,r&P,!0),o}catch(n){return console.error(n),V}})}xClose(e){return this.handleAsync(async()=>{try{const s=this.#r.get(e);return s&&(d(`xClose ${s.path}`),this.#r.delete(e),s.flags&K&&this.#t.run("readwrite",({blocks:r})=>{r.delete(IDBKeyRange.bound([s.path],[s.path,[]]))})),o}catch(s){return console.error(s),u}})}xRead(e,s,r){return this.handleAsync(async()=>{const t=this.#r.get(e);d(`xRead ${t.path} ${s.byteLength} ${r}`);try{return await this.#t.run("readonly",async({blocks:a})=>{let i=0;for(;i<s.byteLength;){const c=r+i,h=c<t.block0.data.byteLength?t.block0:await a.get(this.#o(t,-c));if(!h||h.data.byteLength-h.offset<=c)return s.fill(0,i),H;const _=s.subarray(i),E=c+h.offset,L=Math.min(Math.max(h.data.byteLength-E,0),_.byteLength);_.set(h.data.subarray(E,E+L)),i+=L}return o})}catch(n){return console.error(n),u}})}xWrite(e,s,r){const t=this.#n.has(e);if(t||performance.now()-this.#a>D){const n=this.handleAsync(async()=>{this.handleAsync!==super.handleAsync&&this.#n.add(e),await new Promise(i=>setTimeout(i));const a=this.#i(e,s,r);return this.#a=performance.now(),a});return t&&this.#n.delete(e),n}return this.#i(e,s,r)}#i(e,s,r){const t=this.#r.get(e);d(`xWrite ${t.path} ${s.byteLength} ${r}`);try{const n=t.block0.fileSize;t.block0.fileSize<r+s.byteLength&&(t.block0.fileSize=r+s.byteLength,t.isMetadataChanged=!0);const a=r===0?t.block0:{path:t.path,offset:-r,version:t.block0.version,data:null};return a.data=s.slice(),t.changedPages?(n===t.block0.fileSize&&t.changedPages.add(-r),r!==0&&this.#t.run("readwrite",({blocks:i})=>i.put(a))):this.#t.run("readwrite",({blocks:i})=>i.put(a)),t.isMetadataChanged=r===0?!1:t.isMetadataChanged,o}catch(n){return console.error(n),u}}xTruncate(e,s){const r=this.#r.get(e);d(`xTruncate ${r.path} ${s}`);try{Object.assign(r.block0,{fileSize:s,data:r.block0.data.slice(0,s)});const t=Object.assign({},r.block0);return this.#t.run("readwrite",({blocks:n})=>{n.delete(this.#o(r,-1/0,-s)),n.put(t)}),o}catch(t){return console.error(t),u}}xSync(e,s){const r=this.#n.has(e);if(r||this.#e.durability!=="relaxed"||performance.now()-this.#a>D){const n=this.handleAsync(async()=>{this.handleAsync!==super.handleAsync&&this.#n.add(e);const a=await this.#c(e,s);return this.#a=performance.now(),a});return r&&this.#n.delete(e),n}const t=this.#r.get(e);return d(`xSync ${t.path} ${s}`),o}async#c(e,s){const r=this.#r.get(e);d(`xSync ${r.path} ${s}`);try{r.isMetadataChanged&&(this.#t.run("readwrite",async({blocks:t})=>{await t.put(r.block0)}),r.isMetadataChanged=!1),await this.#t.sync()}catch(t){return console.error(t),u}return o}xFileSize(e,s){const r=this.#r.get(e);return d(`xFileSize ${r.path}`),s.setBigInt64(0,BigInt(r.block0.fileSize),!0),o}xLock(e,s){return this.handleAsync(async()=>{const r=this.#r.get(e);d(`xLock ${r.path} ${s}`);try{const t=await r.locks.lock(s);return t===o&&r.locks.state===S&&(r.block0=await this.#t.run("readonly",({blocks:n})=>n.get(this.#o(r,0)))),t}catch(t){return console.error(t),u}})}xUnlock(e,s){return this.handleAsync(async()=>{const r=this.#r.get(e);d(`xUnlock ${r.path} ${s}`);try{return r.locks.unlock(s)}catch(t){return console.error(t),u}})}xCheckReservedLock(e,s){return this.handleAsync(async()=>{const r=this.#r.get(e);d(`xCheckReservedLock ${r.path}`);const t=await r.locks.isSomewhereReserved();return s.setInt32(0,t?1:0,!0),o})}xSectorSize(e){return J}xDeviceCharacteristics(e){return U|M|B|Q}xFileControl(e,s,r){const t=this.#r.get(e);switch(d(`xFileControl ${t.path} ${s}`),s){case 11:return t.overwrite=!0,o;case 21:if(t.overwrite)try{return this.handleAsync(async()=>(await this.#l(t),o))}catch(n){return console.error(n),u}if(t.isMetadataChanged)try{this.#t.run("readwrite",async({blocks:n})=>{await n.put(t.block0)}),t.isMetadataChanged=!1}catch(n){return console.error(n),u}return o;case 22:return t.overwrite=!1,o;case 31:return this.handleAsync(async()=>{try{return t.block0.version--,t.changedPages=new Set,this.#t.run("readwrite",async({blocks:n})=>{const a=await n.index("version").getAllKeys(IDBKeyRange.bound([t.path],[t.path,t.block0.version]));for(const i of a)n.delete(i)}),o}catch(n){return console.error(n),u}});case 32:try{const n=Object.assign({},t.block0);n.data=n.data.slice();const a=t.changedPages;return t.changedPages=null,t.isMetadataChanged=!1,this.#t.run("readwrite",async({blocks:i})=>{i.put(n);const c=await i.get([t.path,"purge",0])??{path:t.path,offset:"purge",version:0,data:new Map,count:0};c.count+=a.size;for(const h of a)c.data.set(h,n.version);i.put(c),this.#h(t.path,c.count)}),o}catch(n){return console.error(n),u}case 33:return this.handleAsync(async()=>{try{return t.changedPages=null,t.isMetadataChanged=!1,t.block0=await this.#t.run("readonly",({blocks:n})=>n.get([t.path,0,t.block0.version+1])),o}catch(n){return console.error(n),u}});default:return z}}xAccess(e,s,r){return this.handleAsync(async()=>{try{const t=new URL(e,"file://localhost/").pathname;d(`xAccess ${t} ${s}`);const n=await this.#t.run("readonly",({blocks:a})=>a.getKey(this.#o({path:t},0)));return r.setInt32(0,n?1:0,!0),o}catch(t){return console.error(t),u}})}xDelete(e,s){return this.handleAsync(async()=>{const r=new URL(e,"file://localhost/").pathname;try{return this.#t.run("readwrite",({blocks:t})=>t.delete(IDBKeyRange.bound([r],[r,[]]))),s&&await this.#t.sync(),o}catch(t){return console.error(t),u}})}async purge(e){const s=Date.now();await this.#t.run("readwrite",async({blocks:r})=>{const t=await r.get([e,"purge",0]);if(t){for(const[n,a]of t.data)r.delete(IDBKeyRange.bound([e,n,a],[e,n,1/0],!0,!1));await r.delete([e,"purge",0])}d(`purge ${e} ${t?.data.size??0} pages in ${Date.now()-s} ms`)})}#h(e,s){this.#e.purge==="manual"||this.#s.has(e)||s<this.#e.purgeAtLeast||(globalThis.requestIdleCallback?globalThis.requestIdleCallback(()=>{this.purge(e),this.#s.delete(e)}):setTimeout(()=>{this.purge(e),this.#s.delete(e)}),this.#s.add(e))}#o(e,s,r=0){const t=!s||-s<e.block0.data.length?-1/0:e.block0.version;return IDBKeyRange.bound([e.path,s,t],[e.path,r,1/0])}async#l(e){const s=e.block0.data.length;if(s<18)return;const r=new DataView(e.block0.data.buffer,e.block0.data.byteOffset);let t=r.getUint16(16);if(t===1&&(t=65536),t===s)return;const n=Math.max(s,t),a=n/s,i=n/t,h=r.getUint32(28)*t,_=e.block0.version;await this.#t.run("readwrite",async({blocks:E})=>{const L=await E.index("version").getAllKeys(IDBKeyRange.bound([e.path,_+1],[e.path,1/0]));for(const f of L)E.delete(f);E.delete([e.path,"purge",0]);for(let f=0;f<h;f+=n){const k=await E.getAll(IDBKeyRange.lowerBound([e.path,-(f+n),1/0]),a);for(const g of k)E.delete([g.path,g.offset,g.version]);if(i===1){const g=new Uint8Array(t);for(const R of k)g.set(R.data,-(f+R.offset));const y={path:e.path,offset:-f,version:_,data:g};y.offset===0&&(y.fileSize=h,e.block0=y),E.put(y)}else{const g=k[0];for(let y=0;y<i;++y){const R=-(f+y*t);if(-R>=h)break;const A={path:g.path,offset:R,version:_,data:g.data.subarray(y*t,(y+1)*t)};A.offset===0&&(A.fileSize=h,e.block0=A),E.put(A)}}}})}}function ee(l){return new Promise((e,s)=>{const r=globalThis.indexedDB.open(l,5);r.addEventListener("upgradeneeded",function(){r.result.createObjectStore("blocks",{keyPath:["path","offset","version"]}).createIndex("version",["path","version"])}),r.addEventListener("success",()=>{e(r.result)}),r.addEventListener("error",()=>{s(r.error)})})}export{re as IDBBatchAtomicVFS};
